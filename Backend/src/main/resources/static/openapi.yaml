openapi: 3.1.0
info:
  title: Anteiku API
  description: TODO
  version: 1.0.0

servers:
  - url: http://localhost:8080/api
    description: Local HTTP Development Server

paths:
  /users/register:
    post:
      summary: "Registers a new user"
      operationId: registerUser
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegistrationDto'
      responses:
        200:
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserRegistrationDto'

  /users/public/{username}:
    get:
      summary: "Get list of users by username"
      operationId: getUsersByUsername
      parameters:
        - name: username
          in: path
          description: "username"
          required: true
          schema:
            type: string
      responses:
        200:
          description: "Successful response returning a list of users"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserPublicDto'

  /users/{id}:
    get:
      summary: "Get user public data by id"
      operationId: getUserById
      parameters:
        - name: id
          in: path
          description: "user id"
          required: true
          schema:
            $ref: '#/components/schemas/UserId'
      responses:
        200:
          description: "Successful! Returns user public data."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublicDto'
        404:
          description: "GG, user not found :("
  /users/me:
    get:
      summary: "Get information about myself"
      operationId: getMe
      responses:
        200:
          description: "Returns user info"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfoDto'
        401:
          $ref: '#/components/responses/UnauthorizedError'

  /users/check-email:
    get:
      summary: "Check if email is available"
      operationId: checkEmailAvailability
      parameters:
        - name: email
          in: query
          description: "email to check"
          required: true
          schema:
            $ref: '#/components/schemas/UserEmail'
      responses:
        200:
          description: "Returns availability status"
          content:
            application/json:
              schema:
                type: boolean

  /users/check-username:
    get:
      summary: "Check if username is available"
      operationId: checkUsernameAvailability
      parameters:
        - name: username
          in: query
          description: "username to check"
          required: true
          schema:
            type: string
      responses:
        200:
          description: "Returns availability status"
          content:
            application/json:
              schema:
                type: boolean
  /auth/login:
    post:
      summary: "Send authentication request to a server"
      operationId: authenticateUser
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserAuthDto'
      responses:
        200:
          description: "Returns access token"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserAuthResponseDto'
        401:
          $ref: '#/components/responses/UnauthorizedError'

  /auth/refresh:
    post:
      summary: "Refreshes the user's authentication tokens or redirects him to the login page"
      operationId: refreshAuthTokens
      responses:
        200:
          description: "Returns cookie with a refreshed authentication token"
          headers:
            set-cookie:
              content:
                text/plain:
                  schema:
                    type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserAuthTokensDto'
        303:
          description: "Refresh token is expired, authentication is required. User will be redirected to the login page"
          headers:
            Location:
              content:
                text/plain:
                  schema:
                    const: "http://0.0.0.0:3000/login" # https://github.com/OAI/OpenAPI-Specification/issues/2512
        401:
          description: "Invalid access token"

  /api/info:
    get:
      summary: "Get info"
      description: "Returns some info. Requires ADMIN role."
      operationId: getAppInfo
      security:
        - oauth2: [ ]
      responses:
        200:
          description: "info retrieved successfully"
          content:
            application/json:
              schema:
                type: object
                properties:
                  app:
                    type: string
                  version:
                    type: string
        401:
          description: "User not authenticated"
        403:
          description: "Forbidden - requires ADMIN role"

  /friends:
    get:
      summary: "Get my friends list"
      operationId: getMyFriends
      security:
        - bearerAuth: [ ]
      responses:
        200:
          description: "List of friends"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FriendDto'

  /friends/{userId}:
      post:
        summary: "Send a friend request"
        operationId: addFriend
        parameters:
          - name: userId
            in: path
            required: true
            schema:
              type: string
              format: uuid
        responses:
          200:
            description: "Request sent"
          400:
            description: "User not found or already friends"

      put:
        summary: "Accept a friend request"
        operationId: acceptFriend
        parameters:
          - name: userId
            in: path
            required: true
            description: "The ID of the person who sent the request"
            schema:
              type: string
              format: uuid
        responses:
          200:
            description: "Friendship accepted"

      delete:
        summary: "Remove friend or cancel request"
        operationId: removeFriend
        parameters:
          - name: userId
            in: path
            required: true
            schema:
              type: string
              format: uuid
        responses:
          200:
            description: "Removed"

  /friends/blocked:
    get:
      summary: "Get users I have blocked"
      operationId: getMyBlockedUsers
      responses:
        200:
          description: "List of blocked users"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FriendDto'

  /friends/{userId}/block:
      post:
        summary: "Block a user"
        description: "Blocks the user. If a friendship or request exists, it is overridden."
        operationId: blockUser
        parameters:
          - name: userId
            in: path
            required: true
            description: "ID of the user to block"
            schema:
              type: string
              format: uuid
        responses:
          200:
            description: "User blocked successfully"
          400:
            description: "Cannot block self or user not found"

      delete:
        summary: "Unblock a user"
        operationId: unblockUser
        parameters:
          - name: userId
            in: path
            required: true
            description: "ID of the user to unblock"
            schema:
              type: string
              format: uuid
        responses:
          200:
            description: "User unblocked successfully"

  /friends/requests:
    get:
      summary: "Get my pending friend requests"
      operationId: getMyRequests
      responses:
        200:
          description: "List of pending friend requests"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FriendDto'

  /chat/rooms:
    get:
      summary: "Get all chat rooms for the current user"
      operationId: getUserChatRooms
      description: "Retrieves a list of all chat rooms (conversations) the current user is part of"
      parameters:
        - name: X-User-Id
          in: header
          description: "Current user's ID"
          required: true
          schema:
            type: string
            format: uuid
      responses:
        200:
          description: "List of chat rooms"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChatRoomDto'
        400:
          description: "Missing or invalid user ID in header"
        401:
          description: "Unauthorized"

  /chat/rooms/{roomId}/messages:
    get:
      summary: "Get messages from a chat room"
      operationId: getRoomMessages
      description: "Retrieves the last 50 messages from a specific chat room, ordered by creation time"
      parameters:
        - name: roomId
          in: path
          description: "The room ID (format: dm-userId1-userId2)"
          required: true
          schema:
            type: string
      responses:
        200:
          description: "List of messages in the room"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ChatMessageResponse'
        404:
          description: "Room not found"

components:
  responses:
    UnauthorizedError:
      description: "Access token is missing"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    UserId:
      type: string
      format: uuid
      description: "User's universally unique identifier"

    Id:
      type: string
      format: uuid
      description: "universally unique identifier"

    UserPassword:
      type: string
      format: password

    UserEmail:
      type: string
      format: email

    UserPublicDto:
      type: object
      description: "Public user data"
      properties:
        id:
          $ref: '#/components/schemas/UserId'
        username:
          type: string
        displayName:
          type: string
        picture:
          type: string
        about:
          type: string
        status:
          type: string
          enum: [ONLINE, IDLE, DND, OFFLINE]
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
        role:
          type: string

    UserAuthDto:
      type: object
      description: "User authentication data"
      properties:
        email:
          $ref: '#/components/schemas/UserEmail'
        password:
          $ref: '#/components/schemas/UserPassword'

    UserAuthTokensDto:
      type: object
      description: "User's access+refresh tokens"
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        refreshTokenExpiresAt:
          type: string
          format: date-time

    UserAuthResponseDto:
      type: object
      description: "User and token info"
      properties:
        authTokens:
          $ref: '#/components/schemas/UserAuthTokensDto'
        userInfo:
          $ref: '#/components/schemas/UserInfoDto'

    UserInfoDto:
      type: object
      description: "User general account info"
      properties:
        id:
          $ref: '#/components/schemas/UserId'
        email:
          $ref: '#/components/schemas/UserEmail'
        username:
          type: string
        role:
          type: string

    UserCredentialsDto:
      type: object
      description: "User credentials"
      properties:
        userId:
          $ref: '#/components/schemas/UserId'
        email:
          $ref: '#/components/schemas/UserEmail'
        password:
          $ref: '#/components/schemas/UserPassword'

    UserRegistrationDto:
      type: object
      description: "User registration data"
      properties:
        username:
          type: string
        email:
          $ref: '#/components/schemas/UserEmail'
        password:
          $ref: '#/components/schemas/UserPassword'

    FriendDto:
      type: object
      description: "Friend relationship informational data"
      properties:
        id:
          $ref: '#/components/schemas/UserId'
        username:
          type: string
        displayName:
          type: string
        picture:
          type: string
        about:
          type: string
        status:
          type: string
          enum: [ONLINE, IDLE, DND, OFFLINE]
        friendStatus:
          type: string
          enum: [FRIEND, PENDING, BLOCKED]

    UserSessionDto:
      type: object
      description: "User session data"
      properties:
        id:
          $ref: '#/components/schemas/Id'
        userId:
          $ref: '#/components/schemas/UserId'
        refreshToken:
          type: string
          format: jwt
        refreshTokenExpiresAt:
          type: string
          format: date-time
        accessToken:
          type: string
          format: jwt
        accessTokenExpiresAt:
          type: string
          format: date-time
#        deviceId:
#          $ref: '#/components/schemas/Id'
        createdAt:
          type: string
          format: date-time
        lastActiveAt:
          type: string
          format: date-time
        revoked:
          type: boolean
        revokedAt:
          type: string
          format: date-time

    ChatRoomDto:
      type: object
      description: "Chat room information"
      properties:
        roomId:
          type: string
          description: "The unique room identifier (format: dm-userId1-userId2)"
        otherUserId:
          $ref: '#/components/schemas/UserId'
        otherUserName:
          type: string
          description: "The username of the other person in the chat"
        otherUserPicture:
          type: string
          format: url
          description: "URL to the other user's profile picture"

    ChatMessageResponse:
      type: object
      description: "Chat message data"
      properties:
        id:
          $ref: '#/components/schemas/Id'
        roomId:
          type: string
          description: "The room ID where this message was sent"
        senderId:
          $ref: '#/components/schemas/UserId'
        content:
          type: string
          description: "Message content (max 2000 characters)"
          maxLength: 2000
        createdAt:
          type: string
          format: date-time
          description: "Timestamp when the message was created"

    ChatMessageRequest:
      type: object
      description: "Request to send a chat message"
      required:
        - roomId
        - senderId
        - content
      properties:
        roomId:
          type: string
          description: "The room ID where the message will be sent (format: dm-userId1-userId2)"
        senderId:
          $ref: '#/components/schemas/UserId'
        content:
          type: string
          description: "Message content (max 2000 characters)"
          maxLength: 2000