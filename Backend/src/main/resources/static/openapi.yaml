openapi: 3.1.0
info:
  title: Anteiku API
  description: TODO
  version: 1.0.0

servers:
  - url: http://localhost:8080/api
    description: Local HTTP Development Server

paths:
  /users/register:
    post:
      summary: "Registers a new user"
      operationId: registerUser
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserRegistrationDto'
      responses:
        200:
          description: ok
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserRegistrationDto'

  /users/public/{username}:
    get:
      summary: "Get list of users by username"
      operationId: getUsersByUsername
      parameters:
        - name: username
          in: path
          description: "username"
          required: true
          schema:
            type: string
      responses:
        200:
          description: "Successful response returning a list of users"
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/UserPublicDto'

  /users/{id}:
    get:
      summary: "Get user public data by id"
      operationId: getUserById
      parameters:
        - name: id
          in: path
          description: "user id"
          required: true
          schema:
            $ref: '#/components/schemas/UserId'
      responses:
        200:
          description: "Successful! Returns user public data."
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserPublicDto'
        404:
          description: "GG, user not found :("

  /users/me:
    get:
      summary: "Get information about myself"
      operationId: getMe
      responses:
        200:
          description: "Returns user info"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserInfoDto'
        401:
          $ref: '#/components/responses/UnauthorizedError'

  /users/check-email:
    get:
      summary: "Check if email is available"
      operationId: checkEmailAvailability
      parameters:
        - name: email
          in: query
          description: "email to check"
          required: true
          schema:
            $ref: '#/components/schemas/UserEmail'
      responses:
        200:
          description: "Returns availability status"
          content:
            application/json:
              schema:
                type: boolean

  /users/check-username:
    get:
      summary: "Check if username is available"
      operationId: checkUsernameAvailability
      parameters:
        - name: username
          in: query
          description: "username to check"
          required: true
          schema:
            type: string
      responses:
        200:
          description: "Returns availability status"
          content:
            application/json:
              schema:
                type: boolean
  /auth/login:
    post:
      summary: "Send authentication request to a server"
      operationId: authenticateUser
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserAuthDto'
      responses:
        200:
          description: "Returns access token"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserAuthResponseDto'
        401:
          $ref: '#/components/responses/UnauthorizedError'

  /auth/refresh:
    post:
      summary: "Refreshes the user's authentication tokens or redirects him to the login page"
      operationId: refreshAuthTokens
      responses:
        200:
          description: "Returns cookie with a refreshed authentication token"
          headers:
            set-cookie:
              content:
                text/plain:
                  schema:
                    type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserAuthTokensDto'
        303:
          description: "Refresh token is expired, authentication is required. User will be redirected to the login page"
          headers:
            Location:
              content:
                text/plain:
                  schema:
                    const: "http://0.0.0.0:3000/login" # https://github.com/OAI/OpenAPI-Specification/issues/2512
        401:
          description: "Invalid access token"

  /organizations:
    post:
      summary: "Creates an organization with specific name"
      operationId: createOrganization
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateOrganizationDto'
      responses:
        201:
          description: "Organization successfully created"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateOrganizationResponseDto'
        '400':
          description: "Invalid input (validation failed)"
        '403':
          description: "Forbidden – insufficient permissions"
        '409':
          description: "Organization with the same name already exist" # Not sure


  /organizations/{id}:
    delete:
      summary: "Delete specified organization"
      operationId: deleteOrganization
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/OrganizationId'
      responses:
        204:
          description: "Organization successfully deleted"
        403:
          description: "Forbidden – not the owner or insufficient permissions"
        404:
          description: "Organization not found"

  /channels:
    post:
      summary: "Creates channel"
      operationId: createChannel
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateChannelDto'
      responses:
        201:
            description: "Channel successfully created"
            content:
              application/json:
                schema:
                  $ref: '#/components/schemas/CreateChannelResponseDto'
        403:
          description: "Forbidden – not the owner or insufficient permissions"
        404:
          description: "Organization not found"

  /channels/{id}:
    delete:
      summary: "Delete specified channel"
      operationId: deleteChannel
      parameters:
        - name: id
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/ChannelId'
            description: "ID of the channel to delete"
      responses:
        204:
          description: "channel successfully deleted"
        403:
          description: "Forbidden – not the owner or insufficient permissions"
        404:
          description: "channel not found"

  /voice:
    post:
      summary: "Creates a voice room and sends invitations to join to other users"
      operationId: createVoiceRoom
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateVoiceRoomDto'
      responses:
        201:
          description: "aboba"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateVoiceRoomResponseDto'

  /roles:
    post:
      summary: "Creates a new role"
      operationId: createNewRole
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateRoleDto'
      responses:
        '201':
          description: "Role created successfully"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CreateRoleResponseDto'
        '400':
          description: "Invalid input (validation failed)"
        '403':
          description: "Forbidden – insufficient permissions"
        '404':
          description: "Organization not found"
        '409':
          description: "Role with the same name already exists in this organization"

  /roles/{roleId}:
    delete:
      summary: "Delete role"
      operationId: deleteRole
      parameters:
        - name: roleId
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/RoleId'
          description: "ID of the role to delete"
      responses:
        '204':
          description: "Role successfully deleted (no content)"
        '403':
          description: "Forbidden – insufficient permissions"
        '404':
          description: "Role not found"

  /members:
    post:
      summary: "Add a new member to organization"
      operationId: addMember
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AddMemberDto'
      responses:
        '201':
          description: "Member added successfully"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AddMemberResponseDto'
        '400':
          description: "Invalid input"
        '403':
          description: "Forbidden – insufficient permissions"
        '404':
          description: "Organization or user not found"
        '409':
          description: "User is already a member of this organization"

  /members/{memberId}:
    delete:
      summary: "Remove member"
      operationId: removeMember
      parameters:
        - name: memberId
          in: path
          required: true
          schema:
            $ref: '#/components/schemas/MemberId'
          description: "ID of the member to remove"
      responses:
        '204':
          description: "Member successfully removed"
        '403':
          description: "Forbidden – insufficient permissions"
        '404':
          description: "Member not found"

components:
  responses:
    UnauthorizedError:
      description: "Access token is missing"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    UserId:
      type: string
      format: uuid
      description: "User's universally unique identifier"

    Id:
      type: string
      format: uuid
      description: "universally unique identifier"

    UserPassword:
      type: string
      format: password

    UserEmail:
      type: string
      format: email

    OrganizationId:
      type: string
      format: uuid

    MemberId:
      type: string
      format: uuid

    ChannelId:
      type: string
      format: uuid

    RoleId:
      type: string
      format: uuid

    UserPublicDto:
      type: object
      description: "Public user data"
      properties:
        id:
          $ref: '#/components/schemas/UserId'
        username:
          type: string
        timestamp:
          type: string
          format: date-time
        role:
          type: string

    UserAuthDto:
      type: object
      description: "User authentication data"
      properties:
        email:
          $ref: '#/components/schemas/UserEmail'
        password:
          $ref: '#/components/schemas/UserPassword'

    UserAuthTokensDto:
      type: object
      description: "User's access+refresh tokens"
      properties:
        accessToken:
          type: string
        refreshToken:
          type: string
        refreshTokenExpiresAt:
          type: string
          format: date-time

    UserAuthResponseDto:
      type: object
      description: "User and token info"
      properties:
        authTokens:
          $ref: '#/components/schemas/UserAuthTokensDto'
        userInfo:
          $ref: '#/components/schemas/UserInfoDto'

    UserInfoDto:
      type: object
      description: "User general account info"
      properties:
        id:
          $ref: '#/components/schemas/UserId'
        email:
          $ref: '#/components/schemas/UserEmail'
        username:
          type: string
        role:
          type: string

    UserCredentialsDto:
      type: object
      description: "User credentials"
      properties:
        userId:
          $ref: '#/components/schemas/UserId'
        email:
          $ref: '#/components/schemas/UserEmail'
        password:
          $ref: '#/components/schemas/UserPassword'

    UserRegistrationDto:
      type: object
      description: "User registration data"
      properties:
        username:
          type: string
        email:
          $ref: '#/components/schemas/UserEmail'
        password:
          $ref: '#/components/schemas/UserPassword'

    UserSessionDto:
      type: object
      description: "User session data"
      properties:
        id:
          $ref: '#/components/schemas/Id'
        userId:
          $ref: '#/components/schemas/UserId'
        refreshToken:
          type: string
          format: jwt
        refreshTokenExpiresAt:
          type: string
          format: date-time
        accessToken:
          type: string
          format: jwt
        accessTokenExpiresAt:
          type: string
          format: date-time
#        deviceId:
#          $ref: '#/components/schemas/Id'
        createdAt:
          type: string
          format: date-time
        lastActiveAt:
          type: string
          format: date-time
        revoked:
          type: boolean
        revokedAt:
          type: string
          format: date-time

    CreateOrganizationDto:
      type: object
      properties:
        name:
          type: string

    CreateOrganizationResponseDto:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/OrganizationId'
        name:
          type: string
        ownerId:
          $ref: '#/components/schemas/UserId'
        createdAt:
          type: string
          format: date-time

    CreateChannelDto:
      type: object
      properties:
        name:
          type: string
        organizationId:
          $ref: '#/components/schemas/OrganizationId'
        channelType:
          type: string
          enum:
            - TEXT
            - VOICE

    CreateChannelResponseDto:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/ChannelId'
        name:
          type: string
        organizationId:
          $ref: '#/components/schemas/OrganizationId'
        channelType:
          type: string
          enum:
            - TEXT
            - VOICE
        createdAt:
          type: string
          format: date-time

    CreateVoiceRoomDto:
      type: object
      properties:
        creatorId:
          $ref: '#/components/schemas/UserId'
        invitedUsers:
          type: array
          items:
            $ref: '#/components/schemas/UserId'

    CreateVoiceRoomResponseDto:
      type: object
      properties:
        roomId:
          type: string
          format: uuid

    CreateRoleDto:
      type: object
      description: "Information about the role to create"
      properties:
        name:
          type: string
        organizationId:
          type: string
          format: uuid

    CreateRoleResponseDto:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/RoleId'
        name:
          type: string
        organizationId:
          $ref: '#/components/schemas/OrganizationId'
        createdAt:
            type: string
            format: date-time

    AddMemberDto:
      type: object
      description: "Information about the user and organization to add user in"
      properties:
        userId:
          $ref: '#/components/schemas/UserId'
        organizationId:
          $ref: '#/components/schemas/OrganizationId'

    AddMemberResponseDto:
      type: object
      properties:
        id:
          $ref: '#/components/schemas/MemberId'
        userId:
          $ref: '#/components/schemas/UserId'
        organizationId:
          $ref: '#/components/schemas/OrganizationId'
        joinedAt:
          type: string
          format: date-time